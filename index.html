<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seb Logística ✨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-top: 64px;
            padding-bottom: 80px;
        }
        .nav-item.active svg, .nav-item.active span { color: #DC2626; }
        .nav-item.active span { font-weight: 600; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background-color: white; border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.07), 0 1px 2px -1px rgb(0 0 0 / 0.07);
            border: 1px solid #e5e7eb;
        }
        .btn-primary {
            background-color: #DC2626; color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; transition: all 0.2s ease-in-out; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn-primary:hover { background-color: #B91C1C; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn-primary:disabled { background-color: #F87171; cursor: not-allowed; }
        .btn-secondary {
            background-color: #374151; color: white; font-weight: 500; padding: 0.5rem 1rem;
            border-radius: 0.5rem; transition: all 0.2s ease-in-out;
        }
        .btn-secondary:hover { background-color: #1F2937; }
        .btn-light {
            background-color: #e5e7eb; color: #374151; font-weight: 600; padding: 0.5rem 1rem;
            border-radius: 0.5rem; transition: all 0.2s ease-in-out;
        }
        .btn-light:hover { background-color: #d1d5db; }
        .btn-danger {
            background-color: transparent; color: #9CA3AF; border: 1px solid #D1D5DB;
            font-weight: 600; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 9999px;
            transition: all 0.2s ease-in-out;
        }
        .btn-danger:hover { background-color: #FEE2E2; color: #EF4444; border-color: #FCA5A5; }
        .input-field {
            width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s; background-color: #f9fafb;
        }
        .input-field:focus {
            outline: none; border-color: #DC2626; box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.2);
            background-color: white;
        }
        .input-field:read-only {
            background-color: #e5e7eb;
            cursor: not-allowed;
        }
        #toast-container {
            position: fixed; top: 80px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border-radius: 0.5rem; color: white; font-weight: 500;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background-color: #16A34A; }
        .toast-error { background-color: #DC2626; }
        .gemini-result { white-space: pre-wrap; line-height: 1.7; }
        .loader {
            width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid #DC2626;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filter-btn {
            background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db;
            padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .filter-btn:hover { background-color: #e5e7eb; }
        .filter-btn.active {
            background-color: #DC2626; color: white; border-color: #DC2626;
        }
        .hidden { display: none; }
    </style>
</head>
<body class="antialiased">

    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-100 px-4">
        <div class="w-full max-w-md">
             <div class="flex items-center justify-center space-x-3 mb-6">
                <svg class="h-10 w-10 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15.75L3 10.5m9 5.25L21 10.5" />
                </svg>
                <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">Seb Logística</h1>
            </div>
            
            <div id="login-form" class="card p-8 space-y-6">
                <h2 class="text-2xl font-bold text-center text-gray-800">Iniciar Sesión</h2>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-600 mb-1">Correo Electrónico</label>
                        <input type="email" id="login-email" class="input-field" placeholder="tu@correo.com" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-600 mb-1">Contraseña</label>
                        <input type="password" id="login-password" class="input-field" placeholder="••••••••" required>
                    </div>
                </div>
                <button id="login-btn" class="w-full btn-primary !mt-8">Ingresar</button>
                <p class="text-center text-sm text-gray-600">
                    ¿No tienes una cuenta? <a href="#" id="show-register" class="font-semibold text-red-600 hover:text-red-500">Regístrate aquí</a>
                </p>
            </div>

            <div id="register-form" class="card p-8 space-y-6 hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800">Crear Cuenta</h2>
                 <div class="space-y-4">
                    <div>
                        <label for="register-username" class="block text-sm font-medium text-gray-600 mb-1">Nombre de Usuario</label>
                        <input type="text" id="register-username" class="input-field" placeholder="Tu Nombre" required>
                    </div>
                    <div>
                        <label for="register-company" class="block text-sm font-medium text-gray-600 mb-1">Empresa</label>
                        <select id="register-company" class="input-field" required>
                            <option>Envía</option>
                            <option>Servientrega</option>
                            <option>Inter Rapidísimo</option>
                            <option>Coordinadora</option>
                            <option>4-72</option>
                            <option>TCC</option>
                        </select>
                    </div>
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-600 mb-1">Correo Electrónico</label>
                        <input type="email" id="register-email" class="input-field" placeholder="tu@correo.com" required>
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-600 mb-1">Contraseña</dlabel>
                        <input type="password" id="register-password" class="input-field" placeholder="Mínimo 6 caracteres" required>
                    </div>
                </div>
                <button id="register-btn" class="w-full btn-primary !mt-8">Registrarse</button>
                 <p class="text-center text-sm text-gray-600">
                    ¿Ya tienes una cuenta? <a href="#" id="show-login" class="font-semibold text-red-600 hover:text-red-500">Inicia sesión</a>
                </p>
            </div>
        </div>
    </div>
    
    <div id="app-container" class="hidden">
        <div id="toast-container"></div>
        
        <header class="fixed top-0 left-0 right-0 bg-white shadow-sm border-b border-gray-200 h-16 flex items-center z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <svg class="h-8 w-8 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15.75L3 10.5m9 5.25L21 10.5" />
                    </svg>
                    <h1 class="text-xl sm:text-2xl font-extrabold text-gray-800 tracking-tight">Seb Logística</h1>
                </div>
                 <div class="flex items-center gap-4">
                    <span id="current-date-header" class="hidden sm:block font-semibold text-sm text-gray-500"></span>
                    <button id="logout-btn" title="Cerrar Sesión" class="text-gray-500 hover:text-red-600 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div id="page-entregas" class="page active"></div>
            <div id="page-devoluciones" class="page"></div>
            <div id="page-historial" class="page space-y-6"></div>
            <div id="page-planificador" class="page space-y-6"></div>
            <div id="page-reportes" class="page space-y-6"></div>
            <div id="page-config" class="page space-y-6"></div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_5px_rgba(0,0,0,0.05)] border-t border-gray-200 h-20 grid grid-cols-6 z-50">
            <button data-page="page-entregas" class="nav-item flex flex-col items-center justify-center text-gray-500 active">
                <svg class="h-7 w-7 mb-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span class="text-[11px]">Entregas</span>
            </button>
            <button data-page="page-devoluciones" class="nav-item flex flex-col items-center justify-center text-gray-500">
                <svg class="h-7 w-7 mb-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg>
                <span class="text-[11px]">Devoluciones</span>
            </button>
            <button data-page="page-historial" class="nav-item flex flex-col items-center justify-center text-gray-500">
                <svg class="h-7 w-7 mb-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                <span class="text-[11px]">Historial</span>
            </button>
            <button data-page="page-planificador" class="nav-item flex flex-col items-center justify-center text-gray-500">
                <svg class="h-7 w-7 mb-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 13v- உண்மையில்" /></svg>
                <span class="text-[11px]">Planificador</span>
            </button>
            <button data-page="page-reportes" class="nav-item flex flex-col items-center justify-center text-gray-500">
                <svg class="h-7 w-7 mb-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <span class="text-[11px]">Reportes</span>
            </button>
            <button data-page="page-config" class="nav-item flex flex-col items-center justify-center text-gray-500">
                <svg class="h-7 w-7 mb-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="text-[11px]">Configurar</span>
            </button>
        </nav>
    </div>
    
<script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore,
        doc,
        setDoc,
        getDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAHBDW4XgyizumyCe7sAzTHbqDCRGUxMUE",
        authDomain: "seb-logistica.firebaseapp.com",
        projectId: "seb-logistica",
        storageBucket: "seb-logistica.appspot.com",
        messagingSenderId: "45977495657",
        appId: "1:45977495657:web:a09f41c839cc8290bc5af8"
    };


    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- AUTH UI ELEMENTS ---
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const logoutBtn = document.getElementById('logout-btn');

    // --- HELPER FUNCTIONS ---
    const validateEmail = (email) => {
        const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    };

    // --- NOTIFICATIONS (Toast) ---
    function showToast(message, type = 'success', container = null) {
        const targetContainer = container || document.getElementById('toast-container');
        const icon = type === 'success' 
            ? `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>` 
            : `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `${icon}<span>${message}</span>`;
        targetContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // --- AUTH LOGIC ---
    showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
    showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
    loginBtn.addEventListener('click', async () => { const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; if (!email || !password) { return showToast('Por favor, completa todos los campos.', 'error', authContainer); } if (!validateEmail(email)) { return showToast('Por favor, ingresa un correo electrónico válido.', 'error', authContainer); } try { loginBtn.disabled = true; loginBtn.innerHTML = '<div class="loader"></div>'; await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Login Error:", error); showToast('Correo o contraseña incorrectos.', 'error', authContainer); } finally { loginBtn.disabled = false; loginBtn.textContent = 'Ingresar'; } });
    registerBtn.addEventListener('click', async () => { const username = document.getElementById('register-username').value; const company = document.getElementById('register-company').value; const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; if (!username || !company || !email || !password) { return showToast('Por favor, completa todos los campos.', 'error', authContainer); } if (!validateEmail(email)) { return showToast('Por favor, ingresa un correo electrónico válido.', 'error', authContainer); } if (password.length < 6) { return showToast('La contraseña debe tener al menos 6 caracteres.', 'error', authContainer); } try { registerBtn.disabled = true; registerBtn.innerHTML = '<div class="loader"></div>'; const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user; await setDoc(doc(db, "users", user.uid), { username: username, company: company, email: email }); } catch (error) { console.error("Registration Error:", error); if (error.code === 'auth/email-already-in-use') { showToast('Este correo electrónico ya está registrado.', 'error', authContainer); } else { showToast('Error al crear la cuenta. Inténtalo de nuevo.', 'error', authContainer); } } finally { registerBtn.disabled = false; registerBtn.textContent = 'Registrarse'; } });
    logoutBtn.addEventListener('click', async () => { await signOut(auth); });

    // --- AUTH STATE OBSERVER ---
    onAuthStateChanged(auth, user => {
        if (user) {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            document.body.style.paddingTop = '64px';
            initializeAppLogic(user);
        } else {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            document.body.style.paddingTop = '0px';
        }
    });


// --- MAIN APPLICATION LOGIC (WRAPPED) ---
function initializeAppLogic(user) {
    
    // --- TEMPLATES HTML ---
    const pageEntregasHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="lg:col-span-1">
                <div class="card p-5 sticky top-20">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">Registrar Entrega</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Fecha de Operación:</label>
                            <input type="date" id="entregaDateInput" class="input-field">
                        </div>
                        <div>
                            <label for="planillaInput" class="block text-sm font-medium text-gray-600 mb-1">N° Planilla Activa</label>
                            <div class="relative flex items-center">
                                <input type="text" id="planillaInput" placeholder="Ej: 763637" class="input-field pr-20">
                                <div class="absolute right-1 flex items-center space-x-1">
                                    <button id="lockPlanillaBtn" title="Bloquear/Desbloquear Planilla" class="p-2 text-gray-400 hover:text-gray-600 rounded-full transition-colors">
                                        <svg id="unlock-icon" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H4.5a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>
                                        <svg id="lock-icon" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <button id="clearPlanillaBtn" title="Limpiar Campo" class="p-2 text-gray-400 hover:text-red-500 rounded-full transition-colors">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4 border-t border-gray-200"/>
                        <div>
                            <label for="entregaMunicipioSelect" class="block text-sm font-medium text-gray-600 mb-1">Municipio</label>
                            <select id="entregaMunicipioSelect" class="input-field"></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="entregaPaqueteSelect" class="block text-sm font-medium text-gray-600 mb-1">Tipo</label>
                                <select id="entregaPaqueteSelect" class="input-field"><option>MT</option><option>PT</option><option>DE</option></select>
                            </div>
                            <div>
                                <label for="cantidadInput" class="block text-sm font-medium text-gray-600 mb-1">Cantidad</label>
                                <input type="number" id="cantidadInput" value="" placeholder="Ej: 1" class="input-field">
                            </div>
                        </div>
                        <div id="kilos-adicionales-wrapper" class="hidden">
                            <label for="kilosAdicionalesInput" class="block text-sm font-medium text-gray-600 mb-1">Kilos Adicionales Totales (para MT)</label>
                            <input type="number" id="kilosAdicionalesInput" placeholder="Ej: 5" class="input-field">
                        </div>
                        <button id="addEntregaBtn" class="w-full btn-primary !mt-6">Añadir Entrega</button>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-1 space-y-6">
                <div class="card">
                    <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                        <h3 id="resumen-title" class="font-bold text-lg text-gray-800">Resumen del Día</h3>
                        <button id="clearDayBtn" class="btn-danger !text-xs !py-1 !px-2">Limpiar <span id="clear-day-label"></span></button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Detalle</th>
                                    <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Cantidad</th>
                                    <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                </tr>
                            </thead>
                            <tbody id="resumenTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div class="bg-gray-50 px-6 py-4 flex justify-end items-center">
                        <span class="text-sm font-bold text-gray-600 uppercase mr-4">Total Neto del Día:</span>
                        <span id="totalGeneral" class="text-xl font-extrabold text-red-600"></span>
                    </div>
                </div>
            </div>
        </div>`;
    const pageDevolucionesHTML = `<div class="max-w-2xl mx-auto">
            <div class="card p-5">
                <h3 class="font-bold text-lg mb-4 text-gray-800">Registro de Devoluciones</h3>
                <div class="space-y-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Fecha de Devolución:</label>
                        <input type="date" id="devolucionDateInput" class="input-field">
                    </div>
                    <hr class="my-2"/>
                    <div>
                        <label for="guiaDevolucionInput" class="block text-sm font-medium text-gray-600 mb-1">N° de Guía</label>
                        <input type="text" id="guiaDevolucionInput" placeholder="Número de la guía devuelta" class="input-field">
                    </div>
                    <div>
                        <label for="municipioDevolucionSelect" class="block text-sm font-medium text-gray-600 mb-1">Municipio</label>
                        <select id="municipioDevolucionSelect" class="input-field"></select>
                    </div>
                    <div>
                        <label for="tipoDevolucionSelect" class="block text-sm font-medium text-gray-600 mb-1">Tipo de Paquete</label>
                        <select id="tipoDevolucionSelect" class="input-field">
                            <option>MT</option>
                            <option>PT</option>
                            <option>DE</option>
                        </select>
                    </div>
                    <button id="addDevolucionBtn" class="w-full btn-secondary !mt-6">Añadir Devolución</button>
                </div>
            </div>
        </div>`;
    const pageConfigHTML = `<div class="card p-5"><h3 class="font-bold text-lg mb-4 text-gray-800">Gestionar Municipios</h3><div class="flex flex-col sm:flex-row gap-4 mb-4"><input type="text" id="municipioInput" placeholder="Nombre del nuevo municipio" class="input-field flex-grow"><button id="addMunicipioBtn" class="btn-secondary w-full sm:w-auto">Agregar</button></div><div id="municipiosList" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div></div><div class="card p-5"><h3 class="font-bold text-lg mb-4 text-gray-800">Gestionar Tarifas Estándar</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end"><div class="md:col-span-2"><label for="tarifaMunicipioSelect" class="block text-sm font-medium text-gray-600 mb-1">Municipio</label><select id="tarifaMunicipioSelect" class="input-field"></select></div><div><label for="tarifaPaqueteSelect" class="block text-sm font-medium text-gray-600 mb-1">Tipo</label><select id="tarifaPaqueteSelect" class="input-field"><option>MT</option><option>PT</option><option>DE</option></select></div><div><label for="tarifaInput" class="block text-sm font-medium text-gray-600 mb-1">Valor</label><input type="number" id="tarifaInput" placeholder="Ej: 8500" class="input-field"></div></div><button id="setTarifaBtn" class="w-full btn-secondary">Asignar Tarifa</button></div><div class="card p-5"><h3 class="font-bold text-lg mb-4 text-gray-800">Tarifa Kilo Adicional (solo MT)</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end"><div class="sm:col-span-1"><label for="kiloMunicipioSelect" class="block text-sm font-medium text-gray-600 mb-1">Municipio</label><select id="kiloMunicipioSelect" class="input-field"></select></div><div><label for="kiloTarifaInput" class="block text-sm font-medium text-gray-600 mb-1">Valor por Kilo Adicional</label><input type="number" id="kiloTarifaInput" placeholder="Ej: 100" class="input-field"></div></div><button id="setKiloTarifaBtn" class="w-full btn-secondary mt-4">Guardar Tarifa Kilo</button></div><div class="card"><div class="p-5 border-b border-gray-200"><h3 class="font-bold text-lg text-gray-800">Tabla de Tarifas</h3></div><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Municipio</th><th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Tarifa MT</th><th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Tarifa PT</th><th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Tarifa DE</th><th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Kilo Adic. (MT)</th></tr></thead><tbody id="tarifasTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>`;
    const pageHistorialHTML = `<div class="card p-5"><h3 class="font-bold text-lg mb-4 text-gray-800">Filtrar Historial</h3><div class="mb-4 space-y-3"><div class="flex flex-wrap gap-2" id="quick-filters-historial"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2 border-t border-gray-200"><div class="relative"><label for="historialFechaInicio" class="block text-sm font-medium text-gray-600 mb-1">Fecha de Inicio</label><input type="date" id="historialFechaInicio" class="input-field"></div><div class="relative"><label for="historialFechaFin" class="block text-sm font-medium text-gray-600 mb-1">Fecha de Fin</label><input type="date" id="historialFechaFin" class="input-field"></div></div></div></div><div class="card"><div class="p-5 border-b border-gray-200"><h3 id="historial-table-title" class="font-bold text-lg text-gray-800">Resultados</h3></div><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Fecha</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Planilla/Guía</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Municipio</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Cant.</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">K.A.</th><th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th></tr></thead><tbody id="historialTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div><div id="historial-summary" class="bg-gray-50 px-6 py-4 flex justify-end items-center"></div></div>`;
    const pagePlanificadorHTML = `<div class="card p-5"><h3 class="font-bold text-lg mb-4 text-gray-800">Planificador de Ruta IA</h3><p class="text-sm text-gray-600 mb-4">Optimiza la ruta para la fecha seleccionada en la pestaña 'Entregas'.</p><div id="planner-destinations" class="mb-4"></div><button id="generate-route-plan-btn" class="w-full btn-primary"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2.5a.5.5 0 01.5-.5h8a.5.5 0 01.5.5v.634a4.503 4.503 0 011.833 2.193l.352.607a2.5 2.5 0 01.315 1.1V15.5a.5.5 0 01-.5.5h-1.375a.5.5 0 01-.5-.5v-1.25a.75.75 0 00-.75-.75h-5.75a.75.75 0 00-.75.75v1.25a.5.5 0 01-.5.5H3.5a.5.5 0 01-.5-.5v-8.456a2.5 2.5 0 01.315-1.1l.352-.607A4.503 4.503 0 015 3.134V2.5zM6 9.5a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm7 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zM5.006 5a3.503 3.503 0 00-1.22 1.43l-.352.608a1.5 1.5 0 00-.189.66V10h13V7.705a1.5 1.5 0 00-.19-.66l-.351-.608A3.503 3.503 0 0014.994 5H5.006z" clip-rule="evenodd" /></svg>Optimizar Ruta del Día</button></div><div id="route-plan-result" class="card hidden"><div class="p-5 border-b border-gray-200"><h3 class="font-bold text-lg text-gray-800">Plan de Ruta Sugerido</h3></div><div class="p-5"><div id="route-plan-content" class="gemini-result text-gray-700"></div></div></div>`;
    const pageReportesHTML = `<div class="card p-5 max-w-2xl mx-auto"><h3 class="font-bold text-lg mb-4 text-gray-800">Generador de Reportes</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6"><div><label for="reporteFechaInicio" class="block text-sm font-medium text-gray-600 mb-1">Desde</label><input type="date" id="reporteFechaInicio" class="input-field"></div><div><label for="reporteFechaFin" class="block text-sm font-medium text-gray-600 mb-1">Hasta</label><input type="date" id="reporteFechaFin" class="input-field"></div></div><div class="flex flex-col sm:flex-row gap-4"><button id="generarReporteBtn" class="w-full btn-secondary flex-1"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2-2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>Descargar PDF Profesional</button><button id="analyze-report-btn" class="w-full btn-primary flex-1">✨ Analizar Rendimiento</button></div></div><div id="report-analysis-result" class="card hidden max-w-2xl mx-auto"><div class="p-5 border-b border-gray-200"><h3 class="font-bold text-lg text-gray-800">Análisis de Rendimiento IA</h3></div><div class="p-5"><div id="report-analysis-content" class="gemini-result text-gray-700"></div></div></div>`;

    document.getElementById('page-entregas').innerHTML = pageEntregasHTML;
    document.getElementById('page-devoluciones').innerHTML = pageDevolucionesHTML;
    document.getElementById('page-config').innerHTML = pageConfigHTML;
    document.getElementById('page-historial').innerHTML = pageHistorialHTML;
    document.getElementById('page-planificador').innerHTML = pagePlanificadorHTML;
    document.getElementById('page-reportes').innerHTML = pageReportesHTML;

    // --- LIBRERÍAS EXTERNAS ---
    const { jsPDF } = window.jspdf;

    // --- ELEMENTOS DEL DOM ---
    const navItems = document.querySelectorAll('.nav-item');
    const pages = document.querySelectorAll('.page');
    const currentDateHeaderEl = document.getElementById('current-date-header');
    
    // Page Entregas
    const entregaDateInput = document.getElementById('entregaDateInput');
    const planillaInput = document.getElementById('planillaInput');
    const lockPlanillaBtn = document.getElementById('lockPlanillaBtn');
    const clearPlanillaBtn = document.getElementById('clearPlanillaBtn');
    const unlockIcon = document.getElementById('unlock-icon');
    const lockIcon = document.getElementById('lock-icon');
    const entregaMunicipioSelect = document.getElementById('entregaMunicipioSelect');
    const entregaPaqueteSelect = document.getElementById('entregaPaqueteSelect');
    const cantidadInput = document.getElementById('cantidadInput');
    const addEntregaBtn = document.getElementById('addEntregaBtn');
    const kilosAdicionalesWrapper = document.getElementById('kilos-adicionales-wrapper');
    const kilosAdicionalesInput = document.getElementById('kilosAdicionalesInput');
    const resumenTitle = document.getElementById('resumen-title');
    const clearDayBtn = document.getElementById('clearDayBtn');
    const clearDayLabel = document.getElementById('clear-day-label');
    const resumenTableBody = document.getElementById('resumenTableBody');
    const totalGeneral = document.getElementById('totalGeneral');
    
    // Page Devoluciones
    const devolucionDateInput = document.getElementById('devolucionDateInput');
    const guiaDevolucionInput = document.getElementById('guiaDevolucionInput');
    const municipioDevolucionSelect = document.getElementById('municipioDevolucionSelect');
    const tipoDevolucionSelect = document.getElementById('tipoDevolucionSelect');
    const addDevolucionBtn = document.getElementById('addDevolucionBtn');

    // Page Config
    const municipioInput = document.getElementById('municipioInput');
    const addMunicipioBtn = document.getElementById('addMunicipioBtn');
    const municipiosList = document.getElementById('municipiosList');
    const tarifaMunicipioSelect = document.getElementById('tarifaMunicipioSelect');
    const tarifaPaqueteSelect = document.getElementById('tarifaPaqueteSelect');
    const tarifaInput = document.getElementById('tarifaInput');
    const setTarifaBtn = document.getElementById('setTarifaBtn');
    const tarifasTableBody = document.getElementById('tarifasTableBody');
    const kiloMunicipioSelect = document.getElementById('kiloMunicipioSelect');
    const kiloTarifaInput = document.getElementById('kiloTarifaInput');
    const setKiloTarifaBtn = document.getElementById('setKiloTarifaBtn');

    // Page Planificador
    const plannerDestinations = document.getElementById('planner-destinations');
    const generateRoutePlanBtn = document.getElementById('generate-route-plan-btn');
    const routePlanResult = document.getElementById('route-plan-result');
    const routePlanContent = document.getElementById('route-plan-content');

    // Page Reportes
    const reporteFechaInicio = document.getElementById('reporteFechaInicio');
    const reporteFechaFin = document.getElementById('reporteFechaFin');
    const generarReporteBtn = document.getElementById('generarReporteBtn');
    const analyzeReportBtn = document.getElementById('analyze-report-btn');
    const reportAnalysisResult = document.getElementById('report-analysis-result');
    const reportAnalysisContent = document.getElementById('report-analysis-content');

    // Page Historial
    const quickFiltersHistorial = document.getElementById('quick-filters-historial');
    const historialFechaInicio = document.getElementById('historialFechaInicio');
    const historialFechaFin = document.getElementById('historialFechaFin');
    const historialTableBody = document.getElementById('historialTableBody');
    const historialSummary = document.getElementById('historial-summary');

    // --- ESTADO DE LA APLICACIÓN ---
    let state = { municipios: [], tarifas: {}, entregas: [], devoluciones: [], tarifasKilo: {} };
    let isDataLoaded = false;

    // --- FUNCIONES HELPER ---
    const getTodaysDate = () => new Date().toISOString().split('T')[0];
    const formatCurrency = (value) => value === 0 ? '$0' : `$${(value || 0).toLocaleString('es-CO')}`;
    const formatDate = (dateString, options = { year: 'numeric', month: 'long', day: 'numeric' }) => new Date(dateString + 'T00:00:00').toLocaleDateString('es-CO', options);
    const formatDateShort = (dateString) => new Date(dateString + 'T00:00:00').toLocaleDateString('es-CO', { year: '2-digit', month: '2-digit', day: '2-digit' });

    // --- NAVEGACIÓN ---
    navItems.forEach(item => { item.addEventListener('click', () => { const pageId = item.dataset.page; pages.forEach(p => p.classList.toggle('active', p.id === pageId)); navItems.forEach(n => n.classList.toggle('active', n.dataset.page === pageId)); window.scrollTo(0, 0); if (pageId === 'page-planificador') { renderPlanner(); } if (pageId === 'page-historial') { renderHistorial(); } }); });
    
    // --- LÓGICA DE GEMINI API ---
    async function callGemini(prompt, buttonToDisable) { if(buttonToDisable) buttonToDisable.disabled = true; const apiKey = ""; const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: prompt }] }], }; try { const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { throw new Error(`Error en la API: ${response.statusText}`); } const result = await response.json(); const text = result.candidates?.[0]?.content?.parts?.[0]?.text; if (!text) { throw new Error("No se recibió una respuesta válida de la IA."); } return text.replace(/\*/g, ''); } catch (error) { console.error("Error llamando a Gemini API:", error); showToast(error.message, 'error'); return null; } finally { if(buttonToDisable) buttonToDisable.disabled = false; } }

    // --- RENDERIZADO ---
    function renderAll() { if (!isDataLoaded) return; const selectedDate = entregaDateInput.value; renderMunicipios(); renderTarifas(); renderJornada(selectedDate); }
    function renderJornada(date) { if (!date) return; renderResumenDiario(date); updateDateDisplays(date); }
    function updateDateDisplays(date) { const isToday = date === getTodaysDate(); const formattedDate = formatDate(date); resumenTitle.textContent = `Resumen para ${formattedDate}`; clearDayLabel.textContent = isToday ? 'Hoy' : formatDate(date, { month: 'short', day: 'numeric' }); }
    function renderMunicipios() { municipiosList.innerHTML = ''; const selects = [tarifaMunicipioSelect, entregaMunicipioSelect, kiloMunicipioSelect, municipioDevolucionSelect]; selects.forEach(s => s.innerHTML = ''); if (state.municipios.length === 0) { municipiosList.innerHTML = `<p class="text-sm text-center text-gray-500 py-4">Aún no hay municipios configurados.</p>`; selects.forEach(s => s.innerHTML = `<option disabled selected>Sin municipios</option>`); } else { state.municipios.sort().forEach(municipio => { const div = document.createElement('div'); div.className = 'flex justify-between items-center bg-gray-50 p-2.5 rounded-md border'; div.innerHTML = `<span class="font-medium text-gray-700">${municipio}</span><button data-municipio="${municipio}" class="btn-danger delete-municipio-btn">x</button>`; municipiosList.appendChild(div); selects.forEach(s => s.innerHTML += `<option value="${municipio}">${municipio}</option>`); }); } }
    function renderTarifas() { tarifasTableBody.innerHTML = ''; if (state.municipios.length === 0) { tarifasTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-6">No hay municipios para mostrar tarifas.</td></tr>`; return; } state.municipios.forEach(municipio => { const t = state.tarifas[municipio] || {}; const kiloTarifa = state.tarifasKilo[municipio]; const format = (v) => v ? formatCurrency(v) : '<span class="text-gray-400">-</span>'; const tr = document.createElement('tr'); tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-800">${municipio}</td><td class="px-6 py-4 whitespace-nowrap text-right text-gray-600">${format(t.MT)}</td><td class="px-6 py-4 whitespace-nowrap text-right text-gray-600">${format(t.PT)}</td><td class="px-6 py-4 whitespace-nowrap text-right text-gray-600">${format(t.DE)}</td><td class="px-6 py-4 whitespace-nowrap text-right font-bold text-blue-600">${format(kiloTarifa)}</td>`; tarifasTableBody.appendChild(tr); }); }
    function renderResumenDiario(selectedDate) {
        resumenTableBody.innerHTML = '';
        const entregasDelDia = state.entregas.filter(e => e.date === selectedDate);
        const devolucionesDelDia = state.devoluciones.filter(d => d.date === selectedDate);
        const granTotal = entregasDelDia.reduce((sum, e) => sum + e.valorTotal, 0) + devolucionesDelDia.reduce((sum, d) => sum + d.valor, 0);

        if (entregasDelDia.length === 0 && devolucionesDelDia.length === 0) {
            resumenTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-8">No hay registros para esta fecha.</td></tr>`;
        } else {
            const groupedByPlanilla = entregasDelDia.reduce((acc, entrega) => { const planilla = entrega.planilla || 'Sin Planilla'; if (!acc[planilla]) acc[planilla] = []; acc[planilla].push(entrega); return acc; }, {});
            for (const planilla in groupedByPlanilla) {
                resumenTableBody.innerHTML += `<tr><td colspan="4" class="px-6 py-2 bg-gray-100 text-gray-800 font-bold text-sm">Planilla: ${planilla}</td></tr>`;
                let subtotalPlanilla = 0;
                groupedByPlanilla[planilla].forEach(e => {
                    const tr = document.createElement('tr');
                    let municipioDisplay = e.municipio;
                    if (e.tipo === 'MT' && e.kilosAdicionales > 0) { municipioDisplay += ` <span class="text-xs text-blue-500 font-normal">(+${e.kilosAdicionales} kg)</span>`; }
                    tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-800">${municipioDisplay}</td><td class="px-6 py-4 whitespace-nowrap text-center font-semibold"><span class="bg-gray-100 text-gray-700 text-xs font-bold px-2 py-1 rounded-full">${e.tipo}</span></td><td class="px-6 py-4 whitespace-nowrap text-center text-gray-600">${e.cantidad}</td><td class="px-6 py-4 whitespace-nowrap text-right font-bold text-gray-700">${formatCurrency(e.valorTotal)}</td>`;
                    resumenTableBody.appendChild(tr);
                    subtotalPlanilla += e.valorTotal;
                });
                resumenTableBody.innerHTML += `<tr><td colspan="3" class="px-6 py-2 text-right font-bold text-gray-600">Subtotal Planilla:</td><td class="px-6 py-2 text-right font-extrabold text-gray-800">${formatCurrency(subtotalPlanilla)}</td></tr>`;
            }
            if (devolucionesDelDia.length > 0) {
                resumenTableBody.innerHTML += `<tr><td colspan="4" class="px-6 py-2 bg-red-100 text-red-800 font-bold text-sm">Devoluciones del Día</td></tr>`;
                devolucionesDelDia.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-800">${d.municipio} <span class="text-xs text-gray-400">(${d.guia})</span></td><td class="px-6 py-4 whitespace-nowrap text-center font-semibold"><span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded-full">${d.tipo}</span></td><td class="px-6 py-4 whitespace-nowrap text-center text-gray-600">1</td><td class="px-6 py-4 whitespace-nowrap text-right font-bold text-red-600">${formatCurrency(d.valor)}</td>`;
                    resumenTableBody.appendChild(tr);
                });
            }
        }
        totalGeneral.textContent = formatCurrency(granTotal);
    }
    function renderPlanner() { const selectedDate = entregaDateInput.value; const destinos = [...new Set(state.entregas.filter(e => e.date === selectedDate).map(e => e.municipio))]; if (destinos.length === 0) { plannerDestinations.innerHTML = `<p class="text-center text-gray-500 py-4">No hay destinos para esta fecha.</p>`; generateRoutePlanBtn.disabled = true; } else { plannerDestinations.innerHTML = `<p class="text-sm font-medium text-gray-600 mb-2">Destinos para ${formatDate(selectedDate)}:</p><div class="flex flex-wrap gap-2">${destinos.map(d => `<span class="bg-gray-100 text-gray-700 text-sm font-semibold px-3 py-1 rounded-full">${d}</span>`).join('')}</div>`; generateRoutePlanBtn.disabled = false; } routePlanResult.classList.add('hidden'); }
    function toggleKilosInput() { if (entregaPaqueteSelect.value === 'MT') { kilosAdicionalesWrapper.classList.remove('hidden'); } else { kilosAdicionalesWrapper.classList.add('hidden'); kilosAdicionalesInput.value = ''; } }
    function renderHistorial() {
        const startDate = historialFechaInicio.value; const endDate = historialFechaFin.value; if (!startDate || !endDate) return;
        
        const filteredEntregas = state.entregas.filter(e => e.date >= startDate && e.date <= endDate).map(e => ({...e, isReturn: false}));
        const filteredDevoluciones = state.devoluciones.filter(d => d.date >= startDate && d.date <= endDate).map(d => ({...d, isReturn: true, planilla: d.guia, cantidad: 1, valorTotal: d.valor, kilosAdicionales: 0}));
        const combinedData = [...filteredEntregas, ...filteredDevoluciones].sort((a, b) => b.date.localeCompare(a.date));

        historialTableBody.innerHTML = ''; 
        let totalPeriodo = 0;
        if (combinedData.length === 0) { 
            historialTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-8">No hay registros en el periodo seleccionado.</td></tr>`; 
        } else { 
            combinedData.forEach(e => {
                const tr = document.createElement('tr');
                const valorClass = e.isReturn ? 'text-red-600' : 'text-gray-700';
                tr.innerHTML = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatDateShort(e.date)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${e.planilla || '-'}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-800">${e.municipio}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">${e.tipo}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">${e.cantidad}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">${e.kilosAdicionales > 0 ? e.kilosAdicionales + ' kg' : '-'}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-semibold ${valorClass}">${formatCurrency(e.valorTotal)}</td>`;
                historialTableBody.appendChild(tr); 
                totalPeriodo += e.valorTotal; 
            }); 
        }
        historialSummary.innerHTML = `<span class="text-sm font-bold text-gray-600 uppercase mr-4">Total Neto del Periodo:</span><span class="text-xl font-extrabold text-red-600">${formatCurrency(totalPeriodo)}</span>`;
    }
    function setupHistorialFilters() {
        const filters = [{ label: 'Últimos 15 días', days: 15 }, { label: 'Último mes', days: 30 }, { label: '1ra Quincena', quincena: 1 }, { label: '2da Quincena', quincena: 2 },];
        quickFiltersHistorial.innerHTML = filters.map(f => `<button class="filter-btn text-sm" data-days="${f.days || ''}" data-quincena="${f.quincena || ''}">${f.label}</button>`).join('');
        quickFiltersHistorial.addEventListener('click', e => { if (e.target.tagName !== 'BUTTON') return; const allBtns = quickFiltersHistorial.querySelectorAll('button'); allBtns.forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); const days = parseInt(e.target.dataset.days); const quincena = parseInt(e.target.dataset.quincena); const today = new Date(); let startDate, endDate; if (days) { endDate = new Date(); startDate = new Date(); startDate.setDate(endDate.getDate() - (days - 1)); } else if (quincena) { const year = today.getFullYear(); const month = today.getMonth(); if (quincena === 1) { startDate = new Date(year, month, 1); endDate = new Date(year, month, 15); } else { startDate = new Date(year, month, 16); endDate = new Date(year, month + 1, 0); } } historialFechaInicio.value = startDate.toISOString().split('T')[0]; historialFechaFin.value = endDate.toISOString().split('T')[0]; renderHistorial(); });
        historialFechaInicio.addEventListener('input', () => { quickFiltersHistorial.querySelectorAll('button').forEach(b => b.classList.remove('active')); renderHistorial(); });
        historialFechaFin.addEventListener('input', () => { quickFiltersHistorial.querySelectorAll('button').forEach(b => b.classList.remove('active')); renderHistorial(); });
        if (quickFiltersHistorial.querySelector('[data-days="15"]')) { quickFiltersHistorial.querySelector('[data-days="15"]').click(); }
    }
    
    // --- LÓGICA DE NEGOCIO Y EVENTOS ---
    lockPlanillaBtn.addEventListener('click', () => { planillaInput.readOnly = !planillaInput.readOnly; if (planillaInput.readOnly) { unlockIcon.classList.add('hidden'); lockIcon.classList.remove('hidden'); lockPlanillaBtn.classList.add('text-red-600', 'hover:text-red-500'); showToast('Planilla bloqueada.', 'success'); } else { unlockIcon.classList.remove('hidden'); lockIcon.classList.add('hidden'); lockPlanillaBtn.classList.remove('text-red-600', 'hover:text-red-500'); showToast('Planilla desbloqueada.', 'success'); } });
    clearPlanillaBtn.addEventListener('click', () => { if (planillaInput.readOnly) { planillaInput.readOnly = false; unlockIcon.classList.remove('hidden'); lockIcon.classList.add('hidden'); lockPlanillaBtn.classList.remove('text-red-600', 'hover:text-red-500'); } planillaInput.value = ''; planillaInput.focus(); });
    entregaDateInput.addEventListener('change', () => renderJornada(entregaDateInput.value));
    entregaPaqueteSelect.addEventListener('change', toggleKilosInput);
    clearDayBtn.addEventListener('click', () => { const selectedDate = entregaDateInput.value; if(confirm(`¿Limpiar todos los registros (entregas y devoluciones) para el ${formatDate(selectedDate)}?`)) { state.entregas = state.entregas.filter(e => e.date !== selectedDate); state.devoluciones = state.devoluciones.filter(d => d.date !== selectedDate); saveAndRender(); showToast(`Registros de la fecha eliminados.`, 'success'); } });
    addMunicipioBtn.addEventListener('click', () => { const nombre = municipioInput.value.trim(); if (nombre && !state.municipios.includes(nombre)) { state.municipios.push(nombre); municipioInput.value = ''; saveAndRender(); showToast(`Municipio "${nombre}" agregado.`, 'success'); } else { showToast(nombre ? 'Ese municipio ya existe.' : 'Ingrese un nombre válido.', 'error'); } });
    municipiosList.addEventListener('click', (e) => { if (e.target.classList.contains('delete-municipio-btn')) { const municipio = e.target.dataset.municipio; if (confirm(`¿Eliminar "${municipio}"? Se borrarán sus tarifas asociadas.`)) { state.municipios = state.municipios.filter(m => m !== municipio); delete state.tarifas[municipio]; delete state.tarifasKilo[municipio]; saveAndRender(); showToast(`Municipio "${municipio}" eliminado.`, 'success'); } } });
    setTarifaBtn.addEventListener('click', () => { const municipio = tarifaMunicipioSelect.value; const tipo = tarifaPaqueteSelect.value; const valor = parseInt(tarifaInput.value, 10); if (!municipio) { showToast('Seleccione un municipio.', 'error'); return; } if (isNaN(valor) || valor <= 0) { showToast('El valor debe ser positivo.', 'error'); return; } if (!state.tarifas[municipio]) state.tarifas[municipio] = {}; state.tarifas[municipio][tipo] = valor; tarifaInput.value = ''; saveAndRender(); showToast(`Tarifa para ${tipo} en ${municipio} guardada.`, 'success'); });
    setKiloTarifaBtn.addEventListener('click', () => { const municipio = kiloMunicipioSelect.value; const valor = parseInt(kiloTarifaInput.value, 10); if (!municipio) { showToast('Seleccione un municipio.', 'error'); return; } if (isNaN(valor) || valor < 0) { showToast('El valor debe ser un número positivo.', 'error'); return; } state.tarifasKilo[municipio] = valor; kiloTarifaInput.value = ''; saveAndRender(); showToast(`Tarifa por kilo adicional guardada para ${municipio}.`, 'success'); });
    addEntregaBtn.addEventListener('click', () => {
        const selectedDate = entregaDateInput.value; const planilla = planillaInput.value.trim(); const municipio = entregaMunicipioSelect.value; const tipo = entregaPaqueteSelect.value; const cantidad = parseInt(cantidadInput.value, 10); const kilosAdicionales = parseInt(kilosAdicionalesInput.value, 10) || 0;
        if (!planilla) { showToast('Debe ingresar un número de planilla.', 'error'); return; }
        if (!municipio) { showToast('Seleccione un municipio.', 'error'); return; }
        if (isNaN(cantidad) || cantidad <= 0) { showToast('La cantidad debe ser positiva.', 'error'); return; }
        const tarifaBase = state.tarifas[municipio]?.[tipo];
        if (tarifaBase === undefined) { showToast(`No hay tarifa base para ${tipo} en ${municipio}.`, 'error'); return; }
        let costoAdicionalTotal = 0;
        if (tipo === 'MT' && kilosAdicionales > 0) { const tarifaPorKilo = state.tarifasKilo[municipio]; if (tarifaPorKilo === undefined) { showToast(`No hay tarifa de kilo adicional configurada para ${municipio}.`, 'error'); return; } costoAdicionalTotal = kilosAdicionales * tarifaPorKilo; }
        const valorTotal = (tarifaBase * cantidad) + costoAdicionalTotal;
        const nuevaEntrega = { id: Date.now() + Math.random(), planilla, municipio, tipo, cantidad, valorTotal, date: selectedDate, kilosAdicionales: tipo === 'MT' ? kilosAdicionales : 0 };
        state.entregas.push(nuevaEntrega);
        cantidadInput.value = ''; kilosAdicionalesInput.value = '';
        saveAndRender(); showToast(`Entrega añadida en ${municipio} para planilla ${planilla}.`, 'success');
    });
    addDevolucionBtn.addEventListener('click', () => {
        const selectedDate = devolucionDateInput.value; const guia = guiaDevolucionInput.value.trim(); const municipio = municipioDevolucionSelect.value; const tipo = tipoDevolucionSelect.value;
        if (!guia || !municipio) { showToast('Completa todos los campos para la devolución.', 'error'); return; }
        const tarifa = state.tarifas[municipio]?.[tipo];
        if (tarifa === undefined) { showToast(`No hay tarifa para ${tipo} en ${municipio} para calcular la deducción.`, 'error'); return; }
        const nuevaDevolucion = { id: Date.now() + Math.random(), guia, municipio, tipo, valor: -tarifa, date: selectedDate };
        state.devoluciones.push(nuevaDevolucion);
        guiaDevolucionInput.value = '';
        saveAndRender();
        showToast(`Devolución de guía ${guia} registrada. Se dedujo ${formatCurrency(tarifa)}.`, 'success');
    });
    generarReporteBtn.addEventListener('click', () => {
        const [fechaInicio, fechaFin] = [reporteFechaInicio.value, reporteFechaFin.value];
        if (!fechaInicio || !fechaFin || fechaInicio > fechaFin) { showToast('Seleccione un rango de fechas válido.', 'error'); return; }
        const entregasData = state.entregas.filter(e => e.date >= fechaInicio && e.date <= fechaFin);
        const devolucionesData = state.devoluciones.filter(d => d.date >= fechaInicio && d.date <= fechaFin);
        if (entregasData.length === 0 && devolucionesData.length === 0) { showToast('No se encontraron registros en esas fechas.', 'error'); return; }

        const doc = new jsPDF();
        const pageHeight = doc.internal.pageSize.height; const pageWidth = doc.internal.pageSize.width;
        const redColor = '#DC2626'; const darkGreyColor = '#374151'; const lightGreyColor = '#f9fafb';
        const drawAppLogoInPDF = (x, y, scale) => { const p = (px, py) => ({ x: px * scale + x, y: py * scale + y }); const drawLine = (p1, p2) => doc.line(p1.x, p1.y, p2.x, p2.y); doc.setDrawColor(redColor); doc.setLineWidth(0.4); drawLine(p(21, 7.5), p(12, 2.25)); drawLine(p(12, 2.25), p(3, 7.5)); drawLine(p(21, 7.5), p(12, 12.75)); drawLine(p(3, 7.5), p(12, 12.75)); drawLine(p(3, 7.5), p(3, 16.5)); drawLine(p(12, 12.75), p(12, 21.75)); drawLine(p(21, 7.5), p(21, 16.5)); drawLine(p(3, 16.5), p(12, 21.75)); drawLine(p(21, 16.5), p(12, 21.75)); doc.setLineWidth(0.6); drawLine(p(12, 15.75), p(3, 10.5)); drawLine(p(12, 15.75), p(21, 10.5)); };
        const addHeader = (fechaInicio, fechaFin) => { doc.setFillColor(darkGreyColor); doc.rect(0, 0, pageWidth, 28, 'F'); drawAppLogoInPDF(14, 9, 0.45); doc.setFont('helvetica', 'bold'); doc.setFontSize(18); doc.setTextColor('#FFFFFF'); doc.text('Reporte de Operaciones', 27, 16); doc.setFontSize(10); doc.text('Seb Logística', 27, 22); if (fechaInicio && fechaFin) { const dateOptions = { day: 'numeric', month: 'short', year: 'numeric' }; const formattedStartDate = formatDate(fechaInicio, dateOptions); const formattedEndDate = formatDate(fechaFin, dateOptions); const dateRangeText = `Periodo: ${formattedStartDate} - ${formattedEndDate}`; doc.setFont('helvetica', 'normal'); doc.setFontSize(9); doc.setTextColor('#E5E7EB'); doc.text(dateRangeText, pageWidth - 14, 19, { align: 'right' }); } };
        const addFooter = () => { const pageCount = doc.internal.getNumberOfPages(); doc.setFontSize(8); doc.setTextColor(150); doc.text(`Página ${doc.internal.getCurrentPageInfo().pageNumber} de ${pageCount}`, pageWidth - 25, pageHeight - 10); doc.text(`Generado: ${new Date().toLocaleString('es-CO')}`, 14, pageHeight - 10); };
        
        const totalEntregasValor = entregasData.reduce((sum, e) => sum + e.valorTotal, 0);
        const totalDevolucionesValor = devolucionesData.reduce((sum, d) => sum + d.valor, 0);
        const totalFacturadoNeto = totalEntregasValor + totalDevolucionesValor;
        const totalEntregasUnidades = entregasData.reduce((sum, e) => sum + e.cantidad, 0);
        const municipiosVisitados = new Set(entregasData.map(e => e.municipio)).size;
        
        const summaryData = [ { title: 'TOTAL NETO', value: formatCurrency(totalFacturadoNeto), color: redColor }, { title: 'TOTAL ENTREGAS', value: totalEntregasUnidades.toLocaleString('es-CO') }, { title: 'TOTAL DEVOLUCIONES', value: devolucionesData.length }, { title: 'MUNICIPIOS VISITADOS', value: municipiosVisitados } ];
        
        addHeader(fechaInicio, fechaFin);
        const cardWidth = (pageWidth - 28 - 15) / 4;
        summaryData.forEach((item, i) => { const cardX = 14 + i * (cardWidth + 5); doc.setFillColor('#FFFFFF'); doc.setDrawColor('#E5E7EB'); doc.roundedRect(cardX, 38, cardWidth, 20, 3, 3, 'FD'); doc.setFontSize(8); doc.setTextColor(darkGreyColor); doc.setFont('helvetica', 'bold'); doc.text(item.title, cardX + cardWidth / 2, 44, { align: 'center' }); doc.setFontSize(14); doc.setTextColor(item.color || darkGreyColor); doc.text(item.value.toString(), cardX + cardWidth / 2, 53, { align: 'center' }); });

        const allData = [...entregasData, ...devolucionesData];
        const groupedByDate = allData.reduce((acc, curr) => { (acc[curr.date] = acc[curr.date] || []).push(curr); return acc; }, {});
        const sortedDates = Object.keys(groupedByDate).sort();
        let lastFinalY = 68;

        sortedDates.forEach((date) => {
            doc.setFontSize(12); doc.setFont('helvetica', 'bold'); doc.setTextColor(darkGreyColor); doc.text(`Fecha: ${formatDate(date)}`, 14, lastFinalY + 10); lastFinalY += 10;
            const entregasDelDia = groupedByDate[date].filter(item => !item.guia);
            const devolucionesDelDia = groupedByDate[date].filter(item => item.guia);
            
            if (entregasDelDia.length > 0) {
                 const groupedByPlanilla = entregasDelDia.reduce((acc, e) => { const planilla = e.planilla || 'No registrada'; (acc[planilla] = acc[planilla] || []).push(e); return acc; }, {});
                Object.keys(groupedByPlanilla).forEach(planilla => {
                    const entregasPlanilla = groupedByPlanilla[planilla]; let subTotalPlanilla = 0;
                    const body = entregasPlanilla.map(e => { const tarifaBaseUnitaria = state.tarifas[e.municipio]?.[e.tipo] || 0; const valorBaseTotal = tarifaBaseUnitaria * e.cantidad; const valorKilosAdicionales = e.valorTotal - valorBaseTotal; subTotalPlanilla += e.valorTotal; return [ e.municipio, e.cantidad.toString(), e.tipo, formatCurrency(tarifaBaseUnitaria), formatCurrency(valorBaseTotal), e.kilosAdicionales > 0 ? `${e.kilosAdicionales} kg` : '-', valorKilosAdicionales > 0 ? formatCurrency(valorKilosAdicionales) : '-', formatCurrency(e.valorTotal) ]; });
                    const tableHead = [ [{ content: `Planilla (Entregas): ${planilla}`, colSpan: 8, styles: { fillColor: darkGreyColor, textColor: '#FFFFFF', fontStyle: 'bold' } }], ['Municipio', 'Cant.', 'Tipo', 'V. Unitario', 'V. Base', 'K. Adic.', 'Valor K.A.', 'Total'] ];
                    doc.autoTable({ startY: lastFinalY + 5, head: tableHead, body: body, foot: [[ { content: 'Subtotal Planilla:', colSpan: 7, styles: { halign: 'right', fontStyle: 'bold' } }, { content: formatCurrency(subTotalPlanilla), styles: { halign: 'right', fontStyle: 'bold' } } ]], theme: 'striped', margin: { top: 35 }, headStyles: { fillColor: '#4A5568', textColor: '#FFFFFF', fontStyle: 'bold', fontSize: 8, halign: 'center' }, footStyles: { fillColor: lightGreyColor, textColor: darkGreyColor, fontSize: 9, fontStyle: 'bold' }, styles: { fontSize: 8, cellPadding: 2, lineWidth: 0.1, lineColor: '#D1D5DB', valign: 'middle' }, alternateRowStyles: { fillColor: lightGreyColor }, columnStyles: { 0: { halign: 'left', cellWidth: 35 }, 1: { halign: 'center' }, 2: { halign: 'center' }, 3: { halign: 'right' }, 4: { halign: 'right' }, 5: { halign: 'center' }, 6: { halign: 'right' }, 7: { halign: 'right', fontStyle: 'bold' } }, didDrawPage: (data) => { addHeader(fechaInicio, fechaFin); addFooter(); } });
                    lastFinalY = doc.lastAutoTable.finalY;
                });
            }
            if (devolucionesDelDia.length > 0) {
                 const body = devolucionesDelDia.map(d => [d.guia, d.municipio, d.tipo, { content: formatCurrency(d.valor), styles: { textColor: redColor } }]);
                 doc.autoTable({ startY: lastFinalY + 5, head: [[{ content: 'Devoluciones del Día', colSpan: 4, styles: { fillColor: '#FEE2E2', textColor: '#991B1B', fontStyle: 'bold' } }], ['N° Guía', 'Municipio', 'Tipo', 'Valor Deducido']], body: body, theme: 'striped', margin: { top: 35 }, headStyles: { fillColor: '#FECACA', textColor: '#991B1B', fontStyle: 'bold', fontSize: 8, halign: 'center' }, styles: { fontSize: 8, cellPadding: 2, lineWidth: 0.1, lineColor: '#FCA5A5' }, columnStyles: { 0: { cellWidth: 40 }, 3: { halign: 'right', fontStyle: 'bold' } }, didDrawPage: (data) => { addHeader(fechaInicio, fechaFin); addFooter(); } });
                lastFinalY = doc.lastAutoTable.finalY;
            }
        });
        
        let finalTableY = doc.lastAutoTable?.finalY || lastFinalY;
        if (finalTableY + 30 > pageHeight) { doc.addPage(); finalTableY = 0; }
        doc.setFillColor('#FFFFFF'); doc.setDrawColor(darkGreyColor); doc.setLineWidth(0.2); doc.roundedRect(pageWidth / 2 - 40, finalTableY + 10, 80, 15, 3, 3, 'FD'); doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor(darkGreyColor); doc.text('TOTAL NETO DEL PERIODO', pageWidth / 2, finalTableY + 15, { align: 'center' }); doc.setFontSize(16); doc.setTextColor(redColor); doc.text(formatCurrency(totalFacturadoNeto), pageWidth / 2, finalTableY + 22, { align: 'center' });
        
        addFooter();
        doc.save(`Reporte_Seb_Logistica_${fechaInicio}_a_${fechaFin}.pdf`);
        showToast('Reporte PDF profesional generado.', 'success');
    });
    analyzeReportBtn.addEventListener('click', async () => { const [fechaInicio, fechaFin] = [reporteFechaInicio.value, reporteFechaFin.value]; if (!fechaInicio || !fechaFin || fechaInicio > fechaFin) { showToast('Seleccione un rango de fechas válido.', 'error'); return; } const data = state.entregas.filter(e => e.date >= fechaInicio && e.date <= fechaFin); if (data.length === 0) { showToast('No se encontraron registros para analizar.', 'error'); return; } const summary = data.map(({ municipio, tipo, cantidad, valorTotal, kilosAdicionales }) => ({ municipio, tipo, cantidad, valor: valorTotal, kilosAdicionales: kilosAdicionales || 0 })); const prompt = `Eres un analista de datos logísticos. Analiza los siguientes datos de entrega en formato JSON desde ${fechaInicio} hasta ${fechaFin}. Proporciona un resumen ejecutivo que incluya: 1. El municipio con mayor facturación total y su valor. 2. El tipo de paquete más rentable (mayor valor total). 3. Un hallazgo o patrón interesante que observes (por ejemplo, qué municipio usa más los kilos adicionales). 4. Una recomendación de negocio accionable basada en los datos. Sé conciso y directo. Aquí están los datos: ${JSON.stringify(summary)}`; reportAnalysisResult.classList.remove('hidden'); reportAnalysisContent.innerHTML = '<div class="flex justify-center items-center py-8"><div class="loader"></div></div>'; const analysis = await callGemini(prompt, analyzeReportBtn); if(analysis) { reportAnalysisContent.textContent = analysis; } else { reportAnalysisContent.innerHTML = '<p class="text-center text-red-500">No se pudo generar el análisis.</p>'; } });
    generateRoutePlanBtn.addEventListener('click', async () => { const selectedDate = entregaDateInput.value; const destinos = [...new Set(state.entregas.filter(e => e.date === selectedDate).map(e => e.municipio))]; if (destinos.length < 2) { showToast('Se necesitan al menos 2 destinos para optimizar la ruta.', 'error'); return; } const prompt = `Actúa como un experto en logística de Colombia. Crea un plan de ruta eficiente para un conductor que debe hacer entregas en los siguientes municipios: ${destinos.join(', ')}. Sugiere un orden lógico para visitar los municipios, comenzando desde el más cercano si es posible (asume un punto de partida genérico como una ciudad principal cercana, por ejemplo Bogotá si hay municipios de Cundinamarca), y añade una breve nota útil para cada parada. Presenta el resultado como una lista numerada.`; routePlanResult.classList.remove('hidden'); routePlanContent.innerHTML = '<div class="flex justify-center items-center py-8"><div class="loader"></div></div>'; const plan = await callGemini(prompt, generateRoutePlanBtn); if (plan) { routePlanContent.textContent = plan; } else { routePlanContent.innerHTML = '<p class="text-center text-red-500">No se pudo generar el plan de ruta.</p>'; } });

    // --- PERSISTENCIA (FIRESTORE) E INICIALIZACIÓN ---
    async function saveAndRender() {
        if (!user) return;
        try { const userDocRef = doc(db, "userData", user.uid); await setDoc(userDocRef, state); } catch(error) { console.error("Error saving data to Firestore: ", error); showToast('Error al guardar los datos.', 'error'); }
        renderAll();
    }
    async function loadStateAndInitialize() {
        if (!user) return;
        const userDocRef = doc(db, "userData", user.uid);
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) { const loadedState = docSnap.data(); state = { ...{ municipios: [], tarifas: {}, entregas: [], devoluciones: [], tarifasKilo: {} }, ...loadedState }; } else { console.log("No data found, starting with fresh state."); }
        isDataLoaded = true;

        currentDateHeaderEl.textContent = formatDate(getTodaysDate());
        entregaDateInput.value = getTodaysDate();
        devolucionDateInput.value = getTodaysDate();
        reporteFechaFin.value = getTodaysDate();
        const unaSemanaAtras = new Date(); unaSemanaAtras.setDate(unaSemanaAtras.getDate() - 7);
        reporteFechaInicio.value = unaSemanaAtras.toISOString().split('T')[0];
        
        setupHistorialFilters();
        renderAll();
        toggleKilosInput();
    }

    loadStateAndInitialize();
}

</script>
</body>
</html>
